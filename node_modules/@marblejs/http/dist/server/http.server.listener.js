"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.httpListener = void 0;
const core_1 = require("@marblejs/core");
const http_responseHandler_1 = require("../response/http.responseHandler");
const http_router_resolver_1 = require("../router/http.router.resolver");
const http_router_factory_1 = require("../router/http.router.factory");
const httpServerClient_reader_1 = require("./internal-dependencies/httpServerClient.reader");
exports.httpListener = (0, core_1.createListener)(config => ask => {
    const { effects = [], middlewares = [], output$, error$, } = config !== null && config !== void 0 ? config : {};
    const client = (0, core_1.useContext)(httpServerClient_reader_1.HttpServerClientToken)(ask);
    const ctx = (0, core_1.createEffectContext)({ ask, client });
    const routing = (0, http_router_factory_1.factorizeRoutingWithDefaults)(effects, middlewares !== null && middlewares !== void 0 ? middlewares : []);
    const sendResponse = (0, http_responseHandler_1.handleResponse)(ask);
    const { resolve } = (0, http_router_resolver_1.resolveRouting)({ routing, ctx, output$, error$ });
    const handle = (req, res) => {
        const marbleReq = req;
        const marbleRes = res;
        marbleRes.send = sendResponse(marbleRes)(marbleReq);
        marbleReq.response = marbleRes;
        resolve(marbleReq);
    };
    handle.config = { routing };
    return handle;
});
