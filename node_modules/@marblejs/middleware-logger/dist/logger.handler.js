"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.loggerHandler = void 0;
const core_1 = require("@marblejs/core");
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
const logger_factory_1 = require("./logger.factory");
const logger_util_1 = require("./logger.util");
const loggerHandler = (opts, logger) => (stamp) => {
    const req = stamp.value;
    const res = req.response;
    return (0, rxjs_1.fromEvent)(res, 'finish').pipe((0, operators_1.take)(1), (0, operators_1.mapTo)(req), (0, operators_1.filter)((0, logger_util_1.isNotSilent)(opts)), (0, operators_1.filter)((0, logger_util_1.filterResponse)(opts)), (0, operators_1.map)((0, logger_factory_1.factorizeLog)(stamp)), (0, operators_1.tap)(message => {
        const level = res.statusCode >= 500
            ? core_1.LoggerLevel.ERROR
            : res.statusCode >= 400
                ? core_1.LoggerLevel.WARN
                : core_1.LoggerLevel.INFO;
        const log = logger({ tag: "http" /* HTTP */, type: 'RequestLogger', message, level });
        return log();
    }));
};
exports.loggerHandler = loggerHandler;
